name: Integration Test

on:
  # Manual trigger only - scheduled upgrades happen in craft-starterkit
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.4'

jobs:
  update-dependencies:
    name: Upgrade Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      updated_packages: ${{ steps.check_changes.outputs.updated_packages }}
      branch_name: ${{ steps.commit.outputs.branch_name }}

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install current dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Upgrade Composer dependencies to latest versions
        id: upgrade
        run: |
          echo "Checking for available upgrades..."
          echo "### Dependency Upgrades" >> $GITHUB_STEP_SUMMARY

          # Get outdated direct dependencies (require section)
          OUTDATED_REQUIRE=$(composer outdated --direct --format=json 2>/dev/null | jq -r '.installed[] | select(.latest != null and .version != .latest) | "\(.name):\(.latest)"' || true)

          if [ -n "$OUTDATED_REQUIRE" ]; then
            echo "Found outdated packages to upgrade:"
            echo "$OUTDATED_REQUIRE"
            echo ""
            echo "#### Production Dependencies" >> $GITHUB_STEP_SUMMARY

            for pkg in $OUTDATED_REQUIRE; do
              PACKAGE_NAME=$(echo "$pkg" | cut -d: -f1)
              LATEST_VERSION=$(echo "$pkg" | cut -d: -f2)

              # Check if it's in require (not require-dev)
              if grep -q "\"$PACKAGE_NAME\"" composer.json && grep -B50 '"require-dev"' composer.json | grep -q "\"$PACKAGE_NAME\""; then
                continue  # Skip, it's in require-dev
              fi

              echo "Upgrading $PACKAGE_NAME to ^$LATEST_VERSION..."
              echo "- \`$PACKAGE_NAME\` → \`^$LATEST_VERSION\`" >> $GITHUB_STEP_SUMMARY

              # Use composer require to update the constraint
              composer require "$PACKAGE_NAME:^$LATEST_VERSION" --no-interaction --no-update || true
            done
          else
            echo "No production dependency upgrades available."
            echo "_No upgrades available_" >> $GITHUB_STEP_SUMMARY
          fi

          # Get outdated dev dependencies
          echo ""
          echo "#### Dev Dependencies" >> $GITHUB_STEP_SUMMARY

          OUTDATED_DEV=$(composer outdated --direct --format=json 2>/dev/null | jq -r '.installed[] | select(.latest != null and .version != .latest) | .name' || true)

          if [ -n "$OUTDATED_DEV" ]; then
            for PACKAGE_NAME in $OUTDATED_DEV; do
              # Check if it's in require-dev
              if grep -A100 '"require-dev"' composer.json | grep -q "\"$PACKAGE_NAME\""; then
                LATEST_VERSION=$(composer outdated --direct --format=json 2>/dev/null | jq -r ".installed[] | select(.name == \"$PACKAGE_NAME\") | .latest")

                if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
                  echo "Upgrading dev dependency $PACKAGE_NAME to ^$LATEST_VERSION..."
                  echo "- \`$PACKAGE_NAME\` → \`^$LATEST_VERSION\`" >> $GITHUB_STEP_SUMMARY
                  composer require --dev "$PACKAGE_NAME:^$LATEST_VERSION" --no-interaction --no-update || true
                fi
              fi
            done
          else
            echo "_No dev upgrades available_" >> $GITHUB_STEP_SUMMARY
          fi

          # Now run the actual update
          echo ""
          echo "Running composer update..."
          composer update --no-interaction --prefer-dist --with-all-dependencies

          echo "Upgrade complete."

      - name: Run unit tests
        run: vendor/bin/pest --ci

      - name: Run static analysis
        run: vendor/bin/phpstan analyse --error-format=github

      - name: Check for changes
        id: check_changes
        run: |
          # Check both composer.json and composer.lock for changes
          if git diff --quiet composer.json composer.lock; then
            echo "No changes to composer.json or composer.lock"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Show what changed
            echo "### Changes Summary" >> $GITHUB_STEP_SUMMARY
            if ! git diff --quiet composer.json; then
              echo "- composer.json modified (version constraints updated)" >> $GITHUB_STEP_SUMMARY
            fi
            if ! git diff --quiet composer.lock; then
              echo "- composer.lock modified (dependencies updated)" >> $GITHUB_STEP_SUMMARY
            fi

            # Capture summary for notifications
            UPDATED=$(git diff --stat composer.json composer.lock || echo "See workflow logs")
            echo "updated_packages<<EOF" >> $GITHUB_OUTPUT
            echo "$UPDATED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Configure git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes to temp branch
        id: commit
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="deps/weekly-upgrade-$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH_NAME"
          git add composer.json composer.lock
          git commit -m "chore(deps): weekly dependency upgrade

          Automated weekly upgrade of Composer dependencies to latest versions.
          This includes major version upgrades where available.

          Updated on: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push origin "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

  test-starterkit-integration:
    name: Test Starterkit Integration
    needs: update-dependencies
    if: needs.update-dependencies.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      starterkit_has_changes: ${{ steps.check_starterkit_changes.outputs.has_changes }}

    steps:
      - name: Checkout craft-laravel (updated branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.update-dependencies.outputs.branch_name }}
          path: craft-laravel
          token: ${{ secrets.GH_PAT }}

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Configure npm registry auth
        working-directory: starterkit
        run: |
          echo "@hardimpactdev:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PAT }}" >> .npmrc

      - name: Configure Composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install Composer dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Upgrade npm dependencies to latest versions
        working-directory: starterkit
        run: |
          echo "Checking for npm package upgrades..."
          echo "### npm Dependency Upgrades (starterkit)" >> $GITHUB_STEP_SUMMARY

          # Install npm-check-updates
          bun add -g npm-check-updates

          # Check what would be upgraded
          echo "Available upgrades:"
          bunx ncu || true

          # Upgrade all dependencies in package.json to latest versions
          echo ""
          echo "Upgrading package.json to latest versions..."
          bunx ncu -u

          # Show what changed
          if ! git diff --quiet package.json; then
            echo "package.json was modified with new versions"
            echo "#### Upgraded packages:" >> $GITHUB_STEP_SUMMARY
            git diff package.json | grep "^[+-]" | grep -v "^[+-][+-]" >> $GITHUB_STEP_SUMMARY || true
          else
            echo "No npm upgrades available"
            echo "_No npm upgrades available_" >> $GITHUB_STEP_SUMMARY
          fi

          # Install upgraded dependencies
          echo ""
          echo "Installing upgraded dependencies..."
          bun install

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run App setup (Auth + Dashboard)
        working-directory: starterkit
        run: php artisan craft:setup app

      - name: Verify setup files
        working-directory: starterkit
        run: |
          echo "Verifying Auth files (Fortify-based)..."
          test -f app/Providers/FortifyServiceProvider.php
          test -f config/fortify.php
          test -f app/Actions/Fortify/CreateNewUser.php
          test -f app/Actions/Fortify/ResetUserPassword.php
          test -f resources/js/pages/auth/Login.vue
          test -f resources/js/pages/auth/TwoFactorChallenge.vue
          test -f resources/js/composables/useTwoFactorAuth.ts

          echo "Verifying Dashboard files..."
          test -f app/Http/Controllers/DashboardController.php
          test -f resources/js/pages/Dashboard.vue
          test -f resources/js/pages/settings/TwoFactor.vue

          echo "All setup files verified!"

      - name: Install frontend dependencies
        working-directory: starterkit
        run: bun install

      - name: Build frontend assets
        working-directory: starterkit
        run: bun run build

      - name: Setup database
        working-directory: starterkit
        run: |
          touch database/database.sqlite
          php artisan migrate --force

      - name: Start server and test homepage
        working-directory: starterkit
        run: |
          # Start PHP built-in server in background
          php artisan serve --port=8000 &
          SERVER_PID=$!

          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 5

          # Test homepage responds with 200
          echo "Testing homepage..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000)

          # Kill server
          kill $SERVER_PID 2>/dev/null || true

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Homepage returned HTTP $HTTP_CODE - Success!"
          else
            echo "Homepage returned HTTP $HTTP_CODE - Expected 200"
            exit 1
          fi

      - name: Run starterkit tests
        working-directory: starterkit
        run: |
          if [ -f "vendor/bin/pest" ]; then
            vendor/bin/pest --ci || true
          elif [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit || true
          else
            echo "No test runner found, skipping tests"
          fi

      - name: Check for starterkit npm changes
        id: check_starterkit_changes
        working-directory: starterkit
        run: |
          # Check if package.json or bun.lockb changed
          if git diff --quiet package.json bun.lockb 2>/dev/null; then
            echo "No npm changes in starterkit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "npm changes detected in starterkit"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit starterkit npm upgrades directly to main
        if: steps.check_starterkit_changes.outputs.has_changes == 'true'
        working-directory: starterkit
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push directly to main (tests already passed)
          git add package.json bun.lockb
          git commit -m "chore(deps): weekly npm dependency upgrade ($(date +%Y-%m-%d))

          Automated weekly upgrade of npm dependencies to latest versions.
          Includes major version upgrades where available and compatible.

          All tests passed:
          - Composer integration with craft-laravel
          - Frontend build (bun run build)
          - Homepage rendering verified

          Updated on: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push origin HEAD:main
          echo "Starterkit npm upgrades committed directly to main"

  merge-to-main:
    name: Merge to Main
    needs: [update-dependencies, test-starterkit-integration]
    if: |
      always() &&
      needs.update-dependencies.outputs.has_changes == 'true' &&
      needs.test-starterkit-integration.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dependency updates to main
        env:
          BRANCH_NAME: ${{ needs.update-dependencies.outputs.branch_name }}
        run: |
          git fetch origin

          echo "Merging $BRANCH_NAME into main..."

          # Merge with squash to keep history clean
          git merge --squash "origin/$BRANCH_NAME"
          git commit -m "chore(deps): weekly dependency upgrade ($(date +%Y-%m-%d))

          Automated weekly upgrade of Composer dependencies to latest versions.
          Includes major version upgrades where available and compatible.

          All tests passed:
          - Unit tests (pest)
          - Static analysis (phpstan)
          - Starterkit integration
          - Frontend build
          - Homepage rendering

          Updated on: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push origin main

          # Delete the temp branch
          git push origin --delete "$BRANCH_NAME" || true

  notify-success:
    name: Notify Success (Slack)
    needs: [update-dependencies, test-starterkit-integration, merge-to-main]
    if: |
      always() &&
      needs.update-dependencies.outputs.has_changes == 'true' &&
      needs.merge-to-main.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Dependencies Upgraded Successfully",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Upgrades Merged:*\n• `craft-laravel` - Composer dependencies\n• `craft-starterkit` - npm dependencies (if available)"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Tests Passed:*\n• Unit tests (pest)\n• Static analysis (phpstan)\n• Starterkit integration\n• Frontend build\n• Homepage rendering"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commits"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commits/main"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Failure (Slack)
    needs: [update-dependencies, test-starterkit-integration]
    if: |
      always() &&
      needs.update-dependencies.outputs.has_changes == 'true' &&
      (needs.test-starterkit-integration.result == 'failure' || needs.update-dependencies.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Dependency Upgrade Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repository:* ${{ github.repository }}\n*Date:* ${{ github.event.repository.updated_at || 'Today' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The weekly dependency upgrade failed during testing. Please review the workflow logs to identify which upgrade caused the issue."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Logs"
                      },
                      "style": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Checkout for gh CLI
        uses: actions/checkout@v4

      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ISSUE_BODY=$(cat <<EOF
          ## Dependency Upgrade Failure

          The weekly dependency upgrade workflow failed during integration testing.

          ### Details
          - **Workflow run**: ${RUN_URL}
          - **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Next steps
          1. Review the workflow logs linked above
          2. Identify which dependency upgrade caused the failure
          3. Either fix the compatibility issue or pin the problematic dependency version

          ---
          *This issue was automatically created by the weekly dependency upgrade workflow.*
          EOF
          )

          gh issue create \
            --repo "$REPO" \
            --title "Weekly dependency upgrade failed ($(date +%Y-%m-%d))" \
            --body "$ISSUE_BODY" \
            --label "bug,dependencies"

  notify-no-updates:
    name: Notify No Updates (Slack)
    needs: [update-dependencies]
    if: needs.update-dependencies.outputs.has_changes == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ github.repository }}*: No dependency upgrades available this week. All packages are at their latest versions."
                  }
                }
              ]
            }
